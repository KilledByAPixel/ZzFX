<!--

ZzFX - Zuper Zmall Zeeded Zound Zynth
By Frank Force 2019
    
ZzFX Features

- Micro synth engine with 9 controllable parameters.
- Tiny code footprint (<1k) for the minified version.
- Smaller ZzFXmicro version provided without seeds.
- Can produce a wide variety of sound effect types.
- Seeded sounds can be played with a tiny function call, ex: ZZFX.z(6)
- Use function ZZFX.M() to get the frequency of a musical note.
- Seeded sound paramerters can be overridden.

ZzFX UI Features

- Generate random sounds from seed.
- Stores sounds in list with local storage persistence.
- Parameters can be modified for more control.
- Lock, reset and mutate buttons for each parameter.
- Sounds can be download as a wave file.

Additional notes...
- You can use ZZFX.R() as a random number generator.
- Try playing multiple sounds simultaneously for unique effects.
- You can change the master volume and frequency randomness.
- Feel free to modify any or all of this code!

Todo
- musical notes
- favorite a sound
- way to clear non favorites
- share button

--> 
<!--

  ZzFX MIT License
  
  Copyright (c) 2019 - Frank Force
  
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  
  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.
  
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.

--> 
<!doctype html>
<html>
<meta charset="utf-8">
<head>
<title>ZzFX - Zuper Zmall Zeeded Zound Zynth</title>
<style>
*                            { font-family: "courier"; }
a                            { color:#5AF; }
button                       { font-size:20px; }
select                       { overflow-x:hidden; width:600px; height:450px; }
.slider                      { cursor: pointer; width:200px; }
button.reset                 { width:20px; height:20px; }
button.rand                  { width:20px; height:20px; background-color: #4F4; }
button.resetDefault          { background-color: #44F; }
button.resetLocked           { background-color: #F44; }
button.resetChanged          { background-color: #FF4; }
input.lock                   { width:20px; height:20px; }
input.setting                { width:150px; }
textarea                     { height:35px; }
body,input,select,textarea   { color: #FFF; font-size:20px; }
select,input,textarea,canvas { background-color: #0B0B0B; border:1px solid #FFF; }
</style>
<meta name="google" content="notranslate">
</head>
<body bgcolor="#222">
<center>
<table border=0>
<tr>
<td style='text-align:center'>
Master Volume 
<input title='Volume to scale all sounds by in percent' type="range" min="0" max="100" value="50" class="slider" id="slider_masterVolume" onchange="UpdateSettings();SaveLocalStorage()">
<div id=div_masterVolume style="display:inline;"></div>
</td><td style='text-align:right;'>
<font size=7><b><div style="display:inline;" id=div_logo>‚Ñ§ùï´ùîΩùïè</div></b></font>
</td><td style='text-align:left;'>
<div style="display:inline;" id=div_logo2>
<i>&nbsp;Zuper Zmall Zeeded Zound Zynth</i>
</div>
</td></tr>
<tr>
<td style='text-align:center'>
<a hidden id=a_downloadLink></a>
<button title='Clear all sounds' onclick=ClearButton(1)>Clear All</button>
<button title='Clear non-favorite sounds' onclick=ClearButton()>Clear</button>
<button title='Download the selected wave file' onclick=SaveWave()>Download</button>
<button title='Remove selected sound' onclick=RemoveButton()>Remove</button>
<br><br>
<button title='Toggle favorite on current sound' onclick=FavoriteButton()>Favorite</button>
<button title='Make copy of selected sound' onclick=CopySound()>Copy</button>
<button title='Play selected sound' onclick=PlaySound()>Play</button>
<button title='Create new random sound' onclick=NewSound()>Random</button>
<br>
<br>
</td>
<td colspan=2 rowspan=20 style='text-align:center'>
<select title='Select a sound to play' id=select_soundList onclick='LoadSelected();PlaySound();' onchange='LoadSelected();PlaySound();' size=2></select>
</td>
</tr>
<tr>
<td>
<div id=div_settingsTable></div>
</td>
</tr>
<tr><td height=100%></td></tr>
</table>
<br>
ZzFX JavaScript Code (Use this code to play the sound in your game)
<br>
<textarea title='Code to play the selected sound' id=textarea_code cols=80 disabled></textarea>
<br><button title='Eval the actual ZzFX code' onclick='RandomizeLogo();eval(textarea_code.value)'>Test Code</button>
<a href="ZzFX.min.js" style="font-size:25px" target="_blank">Download ZzFX.min.js</a>
<br>
<br>
ZzFXmicro JavaScript Code (Simplified version without seeds)
<br>
<textarea title='Code to play the selected sound with the micro version' id=textarea_codeMicro cols=80 disabled></textarea>
<br><button title='Eval the actual ZzFXmicro code' onclick='RandomizeLogo();eval(textarea_codeMicro.value)'>Test Code</button>
<a href="ZzFX.micro.js" style="font-size:25px" target="_blank">Download ZzFX.micro.js</a>
<br>
<br>
Sound Wave
<br>
<canvas title='Image of sound wave' id=canvas_soundWave width=1000 height=100></canvas>
</center>
<center>

<a href="https://github.com/KilledByAPixel/ZzFX">ZzFX is Open Source on GitHub!</a>
<br>
ZzFX ¬© <a href="http://www.frankforce.com">Frank Force</a> 2019 ‚òÆ‚ô•‚òª‚êå
<script src="ZzFX.min.js"></script>
<script src="ZzFX.micro.js"></script>
<script>

///////////////////////////////////////////////////////////////////////////////
// ZzFX audio code

function PlaySound()
{
    if (lastPlayedSound)
    {
        lastPlayedSound.stop();
        lastPlayedSound = 0;
    }
    
    lastPlayedSound = ZZFX.z(BuildSound());
    DrawSoundWave(ZZFX.b);
    RandomizeLogo();
}

function BuildSeededSound(sound)
{
    if (sound['seed'] === undefined)
        return sound;

    // apply overrides
    let s = ZZFX.G(sound['seed']);
    for(let setting in sound)
        s[setting] = sound[setting];
    return s;
}

function BuildSound()
{
    let sound = {};
    for(let s of settings)
    {
        let v = parseFloat(document.getElementById("input_"+s.name).value);
        if (!Number.isFinite(v))
            v = 0;
        sound[s.name] = v;
    }
    return sound;
}

function GetCode(sound)
{
    let seedSound = ZZFX.G(sound.seed);
    let code = 'ZZFX.z(';
    let onlyHasSeed = 1;
    let first = 1;
    for(let setting in sound)
    {
        if (setting != 'seed')
        {
            if (seedSound[setting] == sound[setting])
                continue;
            onlyHasSeed = 0;
        }

        let value = sound[setting] + '';
        value = value.replace(/^0+/, ''); // remove leading 0's
        if (value == '')
            value = '0';
        code += first? '{':',';
        code += setting + ':' + value;
        first = 0;
    }
    code += '});';
    
    if (onlyHasSeed)
        code = "ZZFX.z("+sound.seed+");";
    return code;
}

function GetCodeMicro(sound)
{
    let seedSound = ZZFX.G(sound.seed);
    let code = 'zzfx(';
    let first = 1;
    for(let setting in sound)
    {
        if (setting == 'seed')
            continue;
            
        let value = sound[setting] + '';
        value = value.replace(/^0+/, ''); // remove leading 0's
        if (value=='')
            value='0';
        if (!first)
            code += ','
        code += value;
        first = 0;
    }
    
    code += ');';
    return code;
}

///////////////////////////////////////////////////////////////////////////////
// UI

function UpdateSettings(rebuildSound)
{
    let v = slider_masterVolume.value;
    div_masterVolume.innerHTML = v + '%';
    ZZFX.volume = v / 100;
    zzfx_v = v / 100;
    
    if (select_soundList.selectedIndex >= 0)
    {
        let option = select_soundList.options[select_soundList.selectedIndex];
        let index = parseInt(option.value);
        let buildSound = BuildSound();
        let sound = rebuildSound? buildSound : sounds[index];
        textarea_code.value = GetCode(buildSound);
        textarea_codeMicro.value = GetCodeMicro(buildSound);
        
        if (selectedWasChanged)
            sounds[index] = sound;
        
        let browserName = '';
        let seedSound = ZZFX.G(sound.seed);
        for(let s in sound)
        {
            let changed = sound[s] != seedSound[s];
            UpdateResetButton(s, changed, IsLocked(s));
        }
        
        if (sounds[index].favorite)
            browserName += "* ";
        
        let count = 0;
        for(let s in sounds[index])
        {
            let changed = sound[s] != seedSound[s];
            if (s == 'favorite' || s != 'seed' && !changed)
                continue;
            if (count++)
                browserName+=', ';
            browserName += s+':'+sound[s];
        }
        option.innerHTML = browserName;
    }
}

function DrawSoundWave(b)
{
    // draw sound wave
    let x = canvas_soundWave.getContext('2d'); 
    let w = canvas_soundWave.width;
    let h = canvas_soundWave.height;
    canvas_soundWave.width |= 0;
    x.strokeStyle="#FFF";
    x.beginPath();
    for(let i=0; i<b.length; ++i)
        x.lineTo(w*i/b.length, b[i]*h/2+h/2);
    x.stroke();
}

function NewSound()
{
    let seed = ZZFX.R()*1e5|0;
    let sound = ZZFX.G(seed);
    AddToList(sound);
    PlaySound();
    SaveLocalStorage();
}

function CopySound()
{
    let sound = GetSelectedSound();
    AddToList(sound);
    PlaySound();
    SaveLocalStorage();
}

function AddToList(sound, dontRebuild)
{
    let i = sounds.push(sound) - 1;
    let option = document.createElement('option');
    option.value = i;
    select_soundList.appendChild(option);
    select_soundList.selectedIndex = select_soundList.length-1;
    LoadSelected();
    selectedWasChanged = 1;
    UpdateSettings(!dontRebuild);
}

function SelectedWasChanged(name)
{
    if (name == 'seed')
    {
        let seedSound = ZZFX.G(parseInt(input_seed.value));
        let index = select_soundList.options[select_soundList.selectedIndex].value;
        sounds[index] = seedSound;
        LoadSelected(1);
    }
    
    selectedWasChanged = 1;
    UpdateSettings(1);
    PlaySound();
    SaveLocalStorage();
}

function LoadSelected(skipSeed)
{
    let sound = GetSelectedSound();
    for(let s of settings)
    {
        if (IsLocked(s.name))
            continue;
            
        if (skipSeed && s.name == 'seed')
            continue;
    
        document.getElementById("input_"+s.name).value = sound[s.name];
    }
    
    selectedWasChanged = 0;
    UpdateSettings();
}

function RandomizeLogo()
{
    div_logo.style.color=`hsl(${ZZFX.R()*3e3},${50+50*ZZFX.R()}%,${50+50*ZZFX.R()}%)`;
    div_logo2.style.color=`hsl(${ZZFX.R()*3e3},${50+50*ZZFX.R()}%,${50+50*ZZFX.R()}%)`;
}

function FavoriteButton()
{
    let i = select_soundList.selectedIndex;
    let index = select_soundList.options[i].value;
    let s = sounds[index];
    if (!s)
        return;
        
    s.favorite = !s.favorite
    UpdateSettings();
    PlaySound();
    SaveLocalStorage();
}

function ClearButton(clearFavorites)
{
    if (clearFavorites)
    {
        if (!confirm('Are you sure you want clear all sounds?\nThis will DELETE your favorites!'))
            return;
        if (!confirm('Are you positive? This will clear everything!'))
            return;
        slider_masterVolume.value = 50;
    }
    else
    {
        if (!confirm('Are you sure you want clear sounds?\nYour favorites will remain.'))
            return;
    }
    ClearSounds(clearFavorites);
    localStorage.clear();
    PlaySound();
}

function RemoveButton()
{
    let i = select_soundList.selectedIndex;
    let index = select_soundList.options[i].value;
    delete sounds[index];
    select_soundList.options.remove(i);
    
    if (select_soundList.length==0) // always keep one in list
        AddToList(ZZFX.G(0));
    
    if (i>=select_soundList.length)
        i--;
    select_soundList.selectedIndex = i;
    LoadSelected();
    SaveLocalStorage();
    PlaySound();
}

function GetSelectedSound()
{
    let index = select_soundList.options[select_soundList.selectedIndex].value;
    let sound = BuildSeededSound(sounds[index]);
    return sound;
}

function UpdateResetButton(name, changed, locked)
{       
    let resetButton = document.getElementById("input_reset_"+name);
    if (!resetButton)
        return;
       
    let className = locked? 'resetLocked' : changed? 'resetChanged' : 'resetDefault';
    resetButton.className = 'reset ' + className;
}

function IsLocked(name)
{
    let lock = document.getElementById("input_lock_"+name);
    return lock && lock.checked;
}

function ResetSetting(name)
{
    if (IsLocked(name)) // unlock
        document.getElementById("input_lock_"+name).checked = 0;

    let sound = GetSelectedSound();
    let seedSound = ZZFX.G(sound.seed);
    document.getElementById('input_'+name).value = seedSound[name];
    SelectedWasChanged();
}

function MutateSetting(name, step)
{
    if (IsLocked(name)) // unlock
        document.getElementById("input_lock_"+name).checked = 0;
    
    let r = (Math.random())*10 + 1|0
    if (Math.random() > .5)
        r *= -1;
    
    let sound = GetSelectedSound();
    let seedSound = ZZFX.G(sound.seed);
    let v = seedSound[name];
    v += r * step;
    if (v < 0 && name != 'frequencySlide')
        v *= -1;
        
    v = parseFloat(v.toFixed(4));
    document.getElementById('input_'+name).value = v;
    SelectedWasChanged();
}

function ClearSounds(clearFavorites)
{
    select_soundList.selectedIndex=-1;
    while(select_soundList.options.length>0)
        select_soundList.options.remove(0);
    BuildSettingsTable();
    
    let oldSounds = sounds;
    sounds = [];
    if (!clearFavorites)
    {
        for(let s of oldSounds)
            if (s && s.favorite)
                AddToList(s, 1);
    }
    
    if (sounds.length == 0)
        AddToList(ZZFX.G(0));
    selectedWasChanged = 0;
    canvas_soundWave.width |= 0;
    UpdateSettings();
}

///////////////////////////////////////////////////////////////////////////////
// save/load local storage

function SaveLocalStorage()
{
    localStorage.clear();
    
    let j=0;
    for(let i in sounds)
    {
        // convert to string
        let string = "";
        let sound = sounds[i];
        for(let s in sound)
            string += `${s}:${sound[s]}, `;
        
        localStorage['sound_'+j++]=string;
    }
    localStorage.soundCount = j;
    localStorage.volume = slider_masterVolume.value;
}

function LoadLocalStorage()
{
    let soundCount = localStorage.soundCount;
    if (soundCount > 1e3)
        soundCount = 1e3;
    else if (!(soundCount > 0))
        return;
        
    sounds = [];
    select_soundList.selectedIndex=-1;
    while(select_soundList.options.length>0)
        select_soundList.options.remove(0);

    // convert from string
    for(let i = 0; i < soundCount; ++i)
    {
        let sound = {};
        let string = localStorage['sound_'+i];
        eval(`sound={${ string }}`);
        AddToList(sound);
    }
    
    select_soundList.selectedIndex=0;
    LoadSelected();
    
    if (localStorage.volume)
        slider_masterVolume.value = parseFloat(localStorage.volume);
        
    UpdateSettings();
}

///////////////////////////////////////////////////////////////////////////////
// save to wave

function SaveWave()
{    
    PlaySound();
    let buffer = ZZFX.b;
    if (!buffer || !buffer.length)
        return;
    
    a_downloadLink.download = "zzfx.wav";
    a_downloadLink.href = BuildWavUrl(buffer);
    a_downloadLink.click();
}

function BuildWavUrl(samples)
{
    // wave saving adapted from https://gist.github.com/asanoboy/3979747
    let sampleRate = 44100;
    let channels = 1;
    let length = samples.length;
    let buffer = new Int16Array(length + 23);
    
    // wave header
    buffer[ 0] = 0x4952; // "RI"
    buffer[ 1] = 0x4646; // "FF"
    buffer[ 2] = (2*length + 15) & 0x0000ffff; // RIFF size
    buffer[ 3] = ((2*length + 15) & 0xffff0000) >> 16; // RIFF size
    buffer[ 4] = 0x4157; // "WA"
    buffer[ 5] = 0x4556; // "VE"
    buffer[ 6] = 0x6d66; // "fm"
    buffer[ 7] = 0x2074; // "t "
    buffer[ 8] = 0x0012; // fmt chunksize: 18
    buffer[ 9] = 0x0000; //
    buffer[10] = 0x0001; // format tag : 1 
    buffer[11] = channels; // channels: 2
    buffer[12] = sampleRate & 0x0000ffff; // sample per sec
    buffer[13] = (sampleRate & 0xffff0000) >> 16; // sample per sec
    buffer[14] = (2*channels*sampleRate) & 0x0000ffff; // byte per sec
    buffer[15] = ((2*channels*sampleRate) & 0xffff0000) >> 16; // byte per sec
    buffer[16] = 0x0004; // block align
    buffer[17] = 0x0010; // bit per sample
    buffer[18] = 0x0000; // cb size
    buffer[19] = 0x6164; // "da"
    buffer[20] = 0x6174; // "ta"
    buffer[21] = (2*length) & 0x0000ffff; // data size[byte]
    buffer[22] = ((2*length) & 0xffff0000) >> 16; // data size[byte]	

    // copy samples to buffer
    for (let i = 0; i < length; i++)
    {
        let s = samples[i];
        if (s >= 1)
            buffer[i+23] = (1 << 15) - 1;
        else if (sampleRate <= -1)
            buffer[i+23] = -(1 << 15);
        else
            buffer[i+23] = Math.round(s * (1 << 15));
    }

    // build the blob
    let eof = 0;
    let bufferNeedle = 0;
    let GetBuffer = (length) =>
    {
        eof = bufferNeedle + length >= buffer.length;
        let rt = new Int16Array(eof?buffer.length - bufferNeedle:length);
        for(let i=0; i<rt.length; i++)
            rt[i] = buffer[i+bufferNeedle];
        bufferNeedle += rt.length;
        return rt.buffer;
    }
    
    let blobData = [];
    while ( !eof )
        blobData.push(GetBuffer(1e3));
    let b = new Blob(blobData, {type:'audio/wav'});
    let URLObject = window.webkitURL || window.URL;
    return URLObject.createObjectURL(b);
}

///////////////////////////////////////////////////////////////////////////////
// sound params

function BuildSettingsTable()
{
    let html = '<table style="text-align:center">';
    for(let s of settings)
    {
        html += '<tr>';
        
        html += '<td style="text-align:right">';
        html += s.niceName + '&nbsp;';
        html += '</td><td>';
        html += `<input title='${s.help}' class="setting" type=number step=${s.step} id=input_${s.name} oninput=SelectedWasChanged('${s.name}')>`
        
        html += '<td style="width:25px">';
        if (s.name == 'seed')
            html += 'üîí</td><td style="width:25px">‚ôªÔ∏è</td><td style="width:25px">üé≤';
        else
        {
            html += `<input title='Lock parameter' id=input_lock_${s.name} oninput=SelectedWasChanged() class="lock" type=checkbox>`;
            html += '</td><td>';
            html += `<button title='Revert to seed' id=input_reset_${s.name} onclick=ResetSetting('${s.name}')></button>`;
            html += '</td><td>';
            html += `<button class='rand' title='Mutate paramater' id=input_mutate_${s.name} onclick=MutateSetting('${s.name}',${s.step})></button>`;
        }
        html += '</td>';
        html += '</tr>';
    }
    
    html += '</table>'
    div_settingsTable.innerHTML = html;
}

function BuildSetting(name, step, niceName, help)
{
    return {name:name, step:step, niceName:niceName, help:help};
}

let settings = 
[
    BuildSetting('seed',             1, 'Seed',                 'Seed used to randomize parameters' ),
    BuildSetting('volume',          .1, 'Volume',               'Volume scale in percent'),
    BuildSetting('randomness',      .1, 'Frequency Randomness', 'How much to randomize frequency in percent'),
    BuildSetting('frequency',       50, 'Frequency',            'Frequency of sound in Hz'),
    BuildSetting('frequencySlide',  .1, 'Frequency Slide',      'How much to change frequency in kHz/s'),
    BuildSetting('length',          .1, 'Length',               'Sound length in seconds'),
    BuildSetting('attack',         .01, 'Attack',               'Attack percent of length'),
    BuildSetting('noise',           .1, 'Noise',                'How much random noise to add in percent'),
    BuildSetting('modulation',       1, 'Modulation Frequency', 'Frequency of modulation wave in Hz'),
    BuildSetting('modulationPhase',.01, 'Modulation Phase',     'Phase of modulation wave in percent'),
]

///////////////////////////////////////////////////////////////////////////////
// input

onkeydown = function(e) 
{
    // play when space is pressed
    if (e.keyCode == 32)
        PlaySound();
}

///////////////////////////////////////////////////////////////////////////////
// init

let lastPlayedSound = 0;
let selectedWasChanged = 0;
let sounds = [];
BuildSettingsTable();
ClearSounds();
LoadLocalStorage();
RandomizeLogo();

</script>
</center>
</body>
</html>